---
title: "Vignette title"
author: 
- name: Charlotte Dawson
  affiliation: Department of Biochemistry and Genetics, 
               La Trobe Institute of Molecular Science, 
               La Trobe University, Australia
- name: Mark Bleackley
  affiliation: Department of Biochemistry and Genetics, 
               La Trobe Institute of Molecular Science, 
               La Trobe University, Australia
- name: Donovan Garcia Ceron
  affiliation: Department of Biochemistry and Genetics, 
               La Trobe Institute of Molecular Science, 
               La Trobe University, Australia
- name: Marilyn Anderson
  affiliation: Department of Biochemistry and Genetics, 
               La Trobe Institute of Molecular Science, 
               La Trobe University, Australia
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  BiocStyle::html_document:
    toc: true
    df_print: kable
package: candidaev
abstract: | 
  This is the abstract.
vignette: > 
  %\VignetteIndexEntry{Vignette title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r knitrOpts, include=FALSE}
# knit options
knitr::opts_knit$set(progress = TRUE, 
                     verbose = TRUE)

# chunk options
knitr::opts_chunk$set(collapse = FALSE,
                      warning = TRUE, 
                      message = TRUE,
                      echo = FALSE,
                      error = TRUE, 
                      comment = "#>")

# check for installation of packages requires to knit this vignette
req_pkgs <- c("BiocStyle", "ggpubr", "stringi", "DT")

check_pkgs <- function(x) {
  if(!requireNamespace(x, quietly = TRUE)) {
    stop(paste0("The package ",
                paste0(x),
                " is required to knit this document. 
                Please install it."))
  }
}

lapply(req_pkgs, check_pkgs)
```

# Preface

## Introduction

This vignette outlines the method used to analyse the label-free quantitative 
LC-MS/MS data obtained for _C. albicans_ (strain DAY286 biofilm) 
extracellular vesicles (EVs) and whole cell lysates (WCL) by Dawson et 
al. (2019). The tools provided in this package, `r Githubpkg("csdaw/candidaev")`
, allows the step-by-step reproduction of the results presented in the paper. 
The manuscript in its submitted form and the `.Rmarkdown` file used to 
generate it can found 
[here](https://github.com/csdaw/candidaev/tree/master/manuscript).

The analysis workflow used in this vignette is derived from the excellent 
**Bioconductor** package `r Biocpkg("DEP")`[^1]. Furthermore, some of the 
plotting functions available in `r Biocpkg("DEP")` have been modified for use 
in this package, `r Githubpkg("csdaw/candidaev")`. 

[^1]: Zhang, X., Smits, A. H., van Tilburg, G. B. A., Ovaa, H., Huber, W., & 
Vermeulen, M. (2018). Proteome-wide identification of ubiquitin interactions 
using UbIA-MS. _Nature Protocols, 13_(3), 530-550. 
[doi:10.1038/nprot.2017.147](https://doi.org/10.1038/nprot.2017.147)

## Experimental design

Extracellular vesicles (EVs) were isolated using differential 
ultracentrifugation from _C. albicans_ biofilms grown using the lab strain 
DAY286 (n = 5). Additionally, scrapings were taken from the biofilms 
and the collected cells were lysed to generate whole cell lysates (WCL). 
Each EV biological replicate was paired with a WCL replicate as they were
derived from the same biofilm.

Samples analysed in this vignette:

* DAY286 Biofilm EV1
* DAY286 Biofilm EV2
* DAY286 Biofilm EV3
* DAY286 Biofilm EV4
* DAY286 Biofilm EV5
* DAY286 Biofilm WCL1 (W1)
* DAY286 Biofilm WCL2 (W2)
* DAY286 Biofilm WCL3 (W3)
* DAY286 Biofilm WCL4 (W4)
* DAY286 Biofilm WCL5 (W5)

These samples were electrophoresed and the SDS-PAGE gel slices were 
reduced, alkylated, and digested with trypsin. The resulting peptides were 
extracted with acetonitrile, analysed by nano-LC-ESI-MS/MS, identified using 
MaxQuant, and quantified via the MaxLFQ algorithm in MaxQuant. 
The `proteinGroups.txt` file output was used for subsequent analyses.

## Data availability

The raw data was searched against the _C. albicans_ (SC5314) UniProt 
reference proteome (UP000000559) using MaxQuant version 1.6.0.16.  The 
`proteinGroups.txt` file analysed in this vignette 
can be easily accessed 
[here](https://github.com/csdaw/candidaev/tree/master/data-raw/lcms). 
It is also installed along with the 
`r Githubpkg("csdaw/candidaev")` package and can be loaded in R with 

```
data(biofilm)
```

The LC-MS/MS raw data, peak data, and results files have been 
deposited in the ProteomeXchange Consortium database via the PRIDE partner 
repository with the data set identifier y and DOI x. 

# Data analysis

## Setup

Text.

```{r biofilmInit}
biofilm <- biofilm %>% 
  filter(Reverse != "+", Potential.contaminant != "+", 
         Only.identified.by.site != "+", Unique.peptides >= 2)

biofilm_lfq <- convert_lfq(biofilm, biofilm_exp)

b1a <- plot_frequency2(biofilm_lfq)

b1b <- plot_numbers2(biofilm_lfq, biofilm_exp) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

ggarrange(b1a, b1b, 
          labels = c("A", "B"), 
          ncol = 2, 
          nrow = 1, 
          font.label = list(size = 24, color = "black"))

knitr::kable(summarise_lfq(biofilm_lfq), 
             caption = "A table caption", 
             col.names = c("Sample", "Mean LFQ intensity", "Median LFQ intensity", 
                           "SD", "CV", "Min LFQ intensity", "Max LFQ intensity", 
                           "Range", "Number of proteins", "Number of NA", "Percent NA"), 
             digits = 1)

```

Text.

Text.

```{r, biofilmFilt}
# filter for proteins identified in min 4/5 reps of EV or WCL
biofilm_filt <- filter_na2(biofilm_lfq, logic = "or", op = "<=", 
                           pat1 = "EV", val1 = 1, 
                           pat2 = "W", val2 = 1)

b2a <- plot_frequency2(biofilm_filt)

b2b <- plot_numbers2(biofilm_filt, biofilm_exp) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

b2c <- plot_mds(biofilm_filt)

ggarrange(ggarrange(b2a, b2b, labels = c("A", "B"), ncol = 1, nrow = 2, 
                    font.label = list(size = 24, color = "black")), 
          b2c, 
          labels = c("", "C"), 
          ncol = 2, 
          nrow = 1, 
          font.label = list(size = 24, color = "black"))
```

Text.

```{r, biofilmNorm}
biofilm_norm <- normalizeCyclicLoess(biofilm_filt)

b3a <- plot_normalization2(biofilm_exp, biofilm_filt, biofilm_norm)

b3b <- plot_mds(biofilm_norm)

b3c <- plot_dendro(biofilm_norm)

ggarrange(b3a, 
          ggarrange(b3b, b3c, labels = c("B", "C"), ncol = 1, nrow = 2, font.label = list(size = 24, color = "black")), 
          labels = c("A", ""), 
          ncol = 2, 
          nrow = 1, 
          font.label = list(size = 24, color = "black"))

```

Text.


```{r biofilmVenn}
# filter for proteins identified in min 1/5 reps of EV
b_ev <- filter_na(biofilm_norm, op = "<=", 
                  pat = "EV", val = 4)

# filter for proteins identified in min 1/5 reps of WCL
b_wcl <- filter_na(biofilm_norm, op = "<=", 
                   pat = "W", val = 4)

b4 <- plot_venn(list("EV" = b_ev, "WCL" = b_wcl), 
                 use_uniprot = TRUE, type = "plot")

b4 <- as_ggplot(b4) + 
  theme(plot.margin = unit(c(0,2,0,2), "lines"))

plot(b4)

```

Text

```{r biofilmTop10}
# get top 10 most abundant protein exclusive to biofilm EVs
# in descending order of abundance
biofilm_top10 <- b_ev %>% 
  tibble::as_tibble(rownames = "id") %>% 
  filter_na(., op = "==", pat = "W", val = 5) %>% 
  select(-contains("W")) %>% 
  mutate(mean = rowMeans(select(., contains("EV")), na.rm = TRUE)) %>% 
  top_n(n = 10, wt = mean) %>% 
  arrange(desc(mean)) %>% 
  mutate(protein_name = match_id(id, uniprot, "UP_accession", "CGD_gene_name"), 
         GO_CC = match_id(id, uniprot, "UP_accession", "GO_CC"))

knitr::kable(biofilm_top10, 
             caption = "This is a table caption", 
             digits = 1)
  

```

Text.

```{r biofilmSum}
# explore percentage missing values in each sample
knitr::kable(summarise_lfq(biofilm_norm), 
             caption = "A table caption", 
             col.names = c("Sample", "Mean LFQ intensity", "Median LFQ intensity", 
                           "SD", "CV", "Min LFQ intensity", "Max LFQ intensity", 
                           "Range", "Number of proteins", "Number of NA", "Percent NA"), 
             digits = 1)

```

TEXT.

TEXT.

```{r biofilmSum2, cache=TRUE}
# should not impute with so many missing values
# filter for proteins with 4-5 NA values in EV or WCL
biofilm_excl <- filter_na2(biofilm_norm, logic = "or", op = ">=", 
                         pat1 = "EV", val1 = 4, 
                         pat2 = "W", val2 = 4)

# filter for proteins with min 3 valid values in EV and WCL
biofilm_both <- filter_na2(biofilm_norm, logic = "and", op = "<=", 
                         pat1 = "EV", val1 = 3, 
                         pat2 = "W", val2 = 3)

knitr::kable(summarise_lfq(biofilm_both), 
             caption = "A table caption", 
             col.names = c("Sample", "Mean LFQ intensity", "Median LFQ intensity", 
                           "SD", "CV", "Min LFQ intensity", "Max LFQ intensity", 
                           "Range", "Number of proteins", "Number of NA", "Percent NA"), 
             digits = 1)

b5a <- grid::grid.grabExpr(plot_missval2(biofilm_both))

b5b <- grid::grid.grabExpr(plot_detect2(biofilm_both))

ggarrange(b5a, b5b, 
          labels = c("A", "B"), 
          ncol = 2, 
          nrow = 1, 
          font.label = list(size = 24, colour = "black"))

```

TEXT. 

```{r biofilmImpute}
# proteins with missing values tend to have lower intensity
# therefore proteins are MNAR, close to detection limit

# use left censored imputation method
biofilm_imp <- impute_QRILC(biofilm_both)

plot_imputation2(biofilm_exp, biofilm_both, biofilm_imp)

```

TEXT.

```{r biofilmDE}
# recombine imputed proteins and non-imputed proteins in matrix
biofilm_de <- rbind(biofilm_excl, biofilm_imp)

# see limma user guide section 9.2 for more info about DE
# create design matrix
b_samp <- data.frame(T = (rep(c("EV", "WCL"), each = 5)))
b_design <- stats::model.matrix(~ 0 + T, data = b_samp)
colnames(b_design) <- c("EV", "WCL")

# make all pair-wise comparisons between EV and WCL
b_cm <- makeContrasts("EV_vs_WCL" = EV - WCL, levels = b_design)
b_fit <- lmFit(biofilm_de, design = b_design)
b_fit_cm <- contrasts.fit(b_fit, b_cm)
b_efit <- eBayes(b_fit_cm)

# extract DE results and create results table
biofilm_tt <- topTable(b_efit, sort.by = "none", number = Inf) %>% 
  as.matrix()

biofilm_res <- combine_result(mat = biofilm_de, toptab = biofilm_tt) %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "UP_accession") %>% 
  mutate(group = case_when(significant == 0 ~ "not sig",
                           significant == 1 & logFC > 0 ~ "ev up",
                           significant == 1 & logFC < 0 ~ "wcl up",
                           is.na(significant) == TRUE & UP_accession %in% rownames(b_ev) ~ "ev ex",
                           is.na(significant) == TRUE & UP_accession %in% rownames(b_wcl) ~ "wcl ex"),
         in_ev = ifelse(UP_accession %in% rownames(b_ev), TRUE, FALSE),
         in_wcl = ifelse(UP_accession %in% rownames(b_wcl), TRUE, FALSE),
         CGD_gene_name = match_id(.[["UP_accession"]], uniprot, "UP_accession", "CGD_gene_name"),
         Protein_name = match_id(.[["UP_accession"]], uniprot, "UP_accession", "Protein_name"), 
         significant = as.logical(significant)) %>%
  select(UP_accession, CGD_gene_name, Protein_name, everything())

biofilm_res_short <- biofilm_res %>% 
  select(CGD_gene_name, Protein_name, logFC, AveExpr, adj.P.Val, significant, group) %>% 
  mutate_at(.vars = vars(logFC, AveExpr), 
            .funs = list(~round(., digits = 2))) %>% 
  mutate(adj.P.Val = signif(adj.P.Val, digits = 3), 
         group = as.factor(group))

DT::datatable(biofilm_res_short, 
              caption = "This is a table caption. Note that adjusted p values have been shortened
              to three significant figures for ease of display.", 
              rownames = FALSE, 
              colnames = c("Gene" = "CGD_gene_name", 
                           "Protein" = "Protein_name", 
                           "p.adj" = "adj.P.Val", 
                           "sig" = "significant"), 
              filter = list(position = "bottom", clear = FALSE, plain = TRUE), 
              class = "display compact", 
              options = list(
                autowidth = TRUE, 
                columnDefs = list(list(width = "40%", targets = 1), 
                                  list(width = "10%", targets = c(0, 2:6)), 
                                  list(targets = 1, 
                                       render = DT::JS(
                                         "function(data, type, row, meta) {",
                                         "return type === 'display' && data.length > 40 ?",
                                         "'<span title=\"' + data + '\">' + data.substr(0, 40) + '...</span>' : data;",
                                         "}")), 
                                  list(targets = 0, 
                                       render = DT::JS("function(data, type, row, meta) {",
                                         "return type === 'display' && data.length > 12 ?",
                                         "'<span title=\"' + data + '\">' + data.substr(0, 12) + '...</span>' : data;",
                                         "}"))
                                  )
                )
              )


```


# Comparison to previous data

TEXT

```{r biofilmComp}
z_list_b <- zarnowski %>% 
  filter(Biofilm_NTS > 0) %>% 
  mutate(gn = match_id(UP_accession, uniprot, "UP_accession", "CGD_gene_name")) %>% 
  pull(gn)

b_ev_list <- match_id(rownames(b_ev), uniprot, "UP_accession", "CGD_gene_name", concat = FALSE)

c1 <- plot_venn(list("mylist" = b_ev_list, "Zarn" = z_list_b), 
                 use_uniprot = FALSE, type = "plot")

c1 <- as_ggplot(c1) + 
  theme(plot.margin = unit(c(0,2,0,2), "lines"))

plot(c1)

```

TEXT















