---
title: "**Defining protein biomarkers for *Candida albicans* extracellular vesicles**"
author: "*Charlotte Dawson^a^, Mark Bleackley^a^, Marilyn Anderson^a^*"
date: "*^a^Department of Biochemistry and Genetics, La Trobe University, Victoria, Australia*"
output: 
    bookdown::pdf_document2:
      latex_engine: xelatex
      fig_caption: yes
      number_sections: yes
      toc: no
      keep_tex: no
    bookdown::word_document2:
      pandoc_args:
        '--lua-filter=components/pagebreak.lua'
      reference_docx: "components/draft_template.docx"
      fig_caption: yes
bibliography: "components/references.bib" 
csl: "components/molecular-and-cellular-proteomics.csl"
link-citations: yes
linkcolor: blue
fontsize: 12pt
geometry: margin=1in
classoption: letterpaper
mainfont: Times New Roman
linestretch: 1.5
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}\fontsize{14bp}{14bp}\selectfont}
  - \posttitle{\par\end{center}}
  - \preauthor{\begin{center}\fontsize{12bp}{12bp}\selectfont}
  - \postauthor{\par\end{center}}
  - \predate{\begin{center}\fontsize{10bp}{10bp}\selectfont}
  - \postdate{\par\end{center}}
  - \usepackage{fancyhdr}
  - \usepackage{lipsum}
  - \pagestyle{fancy}
  - \fancyhead[L]{This is the running title it is rather long}
  - \usepackage{float}
  - \let\origfigure\figure
  - \let\endorigfigure\endfigure
  - \renewenvironment{figure}[1][2] {
    \expandafter\origfigure\expandafter[H]
    } {\endorigfigure}
---

**Running title:** Running title goes here

**Corresponding author:**

\newpage

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>")

library(candidaev)
library(tidyNano)
library(multipanelfigure)
library(limma)
library(dplyr)
library(ggplot2)
library(candidaev)
library(ggpubr)
library(UpSetR)
set.seed(1)

```

```{r yeast}
yeast <- yeast %>% 
  filter(Reverse != "+", Potential.contaminant != "+", 
         Only.identified.by.site != "+", Unique.peptides >= 2)

yeast_lfq <- convert_lfq(yeast, yeast_exp)

# drop EV_1 and WCL_2
yeast_lfq2 <- yeast_lfq[, !colnames(yeast_lfq) %in% c("EV_1", "WCL_2")]

# filter for proteins identified in min 2/3 reps of EV or WCL
yeast_filt2 <- filter_na2(yeast_lfq2, logic = "or", op = "<=", 
                          pat1 = "EV", val1 = 1, 
                          pat2 = "W", val2 = 1)

yeast_norm2 <- normalizeCyclicLoess(yeast_filt2)

# filter for proteins identified in min 1/3 reps of EV
y_ev <- filter_na(yeast_norm2, op = "<=", 
                  pat = "EV", val = 2)

# filter for proteins identified in min 1/3 reps of WCL
y_wcl <- filter_na(yeast_norm2, op = "<=", 
                   pat = "W", val = 2)

# should not impute with so many missing values
yeast_excl <- filter_na2(yeast_norm2, logic = "or", op = "==", 
                         pat1 = "EV", val1 = 3, 
                         pat2 = "W", val2 = 3)

yeast_both <- filter_na2(yeast_norm2, logic = "and", op = "<=", 
                         pat1 = "EV", val1 = 2, 
                         pat2 = "W", val2 = 2)

yeast_imp <- impute_QRILC(yeast_both)

# recombine imputed proteins and non-imputed proteins in matrix
yeast_de <- rbind(yeast_excl, yeast_imp)

# see limma user guide section 9.2 for more info about DE
# create design matrix
y_samp <- data.frame(T = (rep(c("EV", "WCL"), each = 3)))

y_design <- stats::model.matrix(~ 0 + T, data = y_samp)
colnames(y_design) <- c("EV", "WCL")

y_contrasts <- c("EV - WCL")

# make all pair-wise comparisons between EV and WCL
# and perform limma::eBayes()
y_efit <- limma_eBayes(yeast_de, design = y_design, contrasts = y_contrasts)

# extract DE results
yeast_res <- get_results(efit = y_efit, mat = yeast_de, p_val = 0.01, lfc = 0, type = "individual")[[1]]

```

```{r biofilm}
biofilm <- biofilm %>% 
  filter(Reverse != "+", Potential.contaminant != "+", 
         Only.identified.by.site != "+", Unique.peptides >= 2)

biofilm_lfq <- convert_lfq(biofilm, biofilm_exp)

# filter for proteins identified in min 4/5 reps of EV or WCL
biofilm_filt <- filter_na2(biofilm_lfq, logic = "or", op = "<=", 
                           pat1 = "EV", val1 = 1, 
                           pat2 = "W", val2 = 1)

biofilm_norm <- normalizeCyclicLoess(biofilm_filt)

# filter for proteins identified in min 1/5 reps of EV
b_ev <- filter_na(biofilm_norm, op = "<=", 
                  pat = "EV", val = 4)

# filter for proteins identified in min 1/5 reps of WCL
b_wcl <- filter_na(biofilm_norm, op = "<=", 
                   pat = "W", val = 4)

# should not impute with so many missing values
# filter for proteins with 4-5 NA values in EV or WCL
biofilm_excl <- filter_na2(biofilm_norm, logic = "or", op = ">=", 
                         pat1 = "EV", val1 = 4, 
                         pat2 = "W", val2 = 4)

# filter for proteins with min 3 valid values in EV and WCL
biofilm_both <- filter_na2(biofilm_norm, logic = "and", op = "<=", 
                         pat1 = "EV", val1 = 3, 
                         pat2 = "W", val2 = 3)

# proteins with missing values tend to have lower intensity
# therefore proteins are MNAR, close to detection limit

# use left censored imputation method
biofilm_imp <- impute_QRILC(biofilm_both)

# recombine imputed proteins and non-imputed proteins in matrix
biofilm_de <- rbind(biofilm_excl, biofilm_imp)

# see limma user guide section 9.2 for more info about DE
# create design matrix
b_samp <- data.frame(T = (rep(c("EV", "WCL"), each = 5)))

b_design <- stats::model.matrix(~ 0 + T, data = b_samp)
colnames(b_design) <- c("EV", "WCL")

b_contrasts <- c("EV - WCL")

# make all pair-wise comparisons between EV and WCL
# and perform limma::eBayes()
b_efit <- limma_eBayes(biofilm_de, design = b_design, contrasts = b_contrasts)

# extract DE results
biofilm_res <- get_results(efit = b_efit, mat = biofilm_de, p_val = 0.01, lfc = 0, type = "individual")[[1]]

```

```{r atcc}
atcc_lfq <- atcc %>% 
  filter(Reverse != "+", Potential.contaminant != "+", Unique.peptides >= 2) %>% 
  convert_lfq(., atcc_exp)

atcc_filt <- filter_na4(atcc_lfq, "or", "<=", 
                        pat1 = "A10231_EV", 1, 
                        pat2 = "A10231_W", 1, 
                        pat3 = "A90028_EV", 1, 
                        pat4 = "A90028_W", 1)

atcc_norm <- normalizeCyclicLoess(atcc_filt)

# filter for proteins identified in min 1/3 reps of 10231 EV
atcc1_ev <- filter_na(atcc_norm, op = "<=", 
                      pat = "A10231_EV", val = 2)

# filter for proteins identified in min 1/3 reps of 10231 WCL
atcc1_w <- filter_na(atcc_norm, op = "<=", 
                     pat = "A10231_W", val = 2)

# filter for proteins identified in min 1/3 reps of 90028 EV
atcc9_ev <- filter_na(atcc_norm, op = "<=", 
                      pat = "A90028_EV", val = 2)

# filter for proteins identified in min 1/3 reps of 90028 WCL
atcc9_w <- filter_na(atcc_norm, op = "<=", 
                      pat = "A90028_W", val = 2)

# should not impute with so many missing values
# filter for exclusive to 10231 EV or WCL or 90028 EV or WCL
atcc_excl <- filter_na4(atcc_norm, logic = "or", op = "==", 
                        pat1 = "A10231_EV", val1 = 3, 
                        pat2 = "A10231_W", val2 = 3, 
                        pat3 = "A90028_EV", val3 = 3, 
                        pat4 = "A90028_W", val4 = 3)

# filter for proteins with min 1 valid value in all 4 sample types
atcc_both <- filter_na4(atcc_norm, logic = "and", op = "<=", 
                        pat1 = "A10231_EV", val1 = 2, 
                        pat2 = "A10231_W", val2 = 2, 
                        pat3 = "A90028_EV", val3 = 2, 
                        pat4 = "A90028_W", val4 = 2)

# proteins with missing values tend to have lower intensity
# therefore proteins are MNAR, close to detection limit

# use left censored imputation method
atcc_imp <- impute_QRILC(atcc_both)

atcc_de <- rbind(atcc_excl, atcc_imp)

colnames(atcc_de) <- stringi::stri_replace_all_regex(colnames(atcc_de), 
                                                     c("A10231_", "A90028_"), 
                                                     c("A1_", "A9_"), 
                                                     vectorize_all = FALSE)

# see limma user guide section 9.2 for more info about DE
# create design matrix
atcc_samp <- data.frame(T = (rep(c("A1_EV", "A1_WCL", "A9_EV", "A9_WCL"), each = 3)))

atcc_design <- stats::model.matrix(~ 0 + T, data = atcc_samp)
colnames(atcc_design) <- c("A1_EV", "A1_W", "A9_EV", "A9_W")

atcc_contrasts <- c("A1_EV - A1_W", "A9_EV - A9_W", "A1_EV - A9_EV", "A1_W - A9_W")

# make all pair-wise comparisons for specified contrasts
# and perform limma::eBayes()
atcc_efit <- limma_eBayes(atcc_de, atcc_design, atcc_contrasts)

# extract overall results
atcc_overall <- get_results(efit = atcc_efit, mat = atcc_de, p_val = 0.01, lfc = 0, type = "overall")

# extract results for individual comparisons defined in atcc_contrasts
atcc_ind <- get_results(efit = atcc_efit, mat = atcc_de, p_val = 0.01, lfc = 0, type = "individual")

a1_res <- atcc_ind[[1]]

a9_res <- atcc_ind[[2]]

```


# Abbreviations

EV - extracellular vesicle

\newpage

# Abstract

The abstract goes here. Here is a citation [@liao2012].

Here is another citation [@gil-bona2018].

And another [@lin2014].

\newpage

# Introduction

Here is a citation [@marwick2017].

# Experimental procedures

## Subsection 1

## Subsection 2

# Results

# Discussion

# Acknowledgements

# Data availability

# Acknowledgements

\newpage
# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

\newpage

# Figures

```{r figure1, fig.cap='Workflow'}
plot(mtcars[,1:2])
```

\newpage

```{r figure2Data}
nta_metadata <- data.frame(id = c("ATCC10231_1", "ATCC10231_2", "ATCC10231_3", 
                                  "ATCC90028_1", "ATCC90028_2", "ATCC90028_3", 
                                  "Biofilm_1", "Biofilm_2", "Biofilm_3", "Biofilm_4", "Biofilm_5", 
                                  "DAY286_1", "DAY286_2", "DAY286_3"), 
                           Protein_conc = c(0.192, 0.282, 0.287, 
                                            0.424, 0.716, 0.584, 
                                            0.204, 0.198, 0.297, 0.193, 0.416, 
                                            0.437, 0.360, 0.447), 
                           Culture_vol = c(rep(150, 6), rep(1000, 5), rep(200, 3)), 
                           OD600 = c(0.455*20, 0.557*20, 0.615*20, 
                                     0.310*50, 0.337*50, 0.297*50, 
                                     rep(NA, 5), 
                                     36.2, 39.7, 34.0), 
                           stringsAsFactors = FALSE)

nta_techavg <- nta %>% 
  nanolyze(particle_size, Strain, Bio_rep, Dilution, 
           name = "Tech_rep", 
           param_var = True_count)

nta_bioavg <- nta_techavg %>% 
  nanolyze(particle_size, Strain,
           name = "Bio_rep", 
           param_var = Tech_rep_mean) %>% 
  mutate(facet = case_when(Strain == "Biofilm" ~ "first", TRUE ~ "second"))

nta_total <- nta_techavg %>% 
  nanocount(Strain, Bio_rep, Dilution, 
            param_var = Tech_rep_mean) %>% 
  tidyr::unite("id", Strain, Bio_rep) %>% 
  mutate(protein_conc = as.numeric(match_id(id, nta_metadata, "id", "Protein_conc")), 
         od = match_id(id, nta_metadata, "id", "OD600"), 
         part_per_prot = Particle_count / protein_conc / 1000) %>% 
  tidyr::separate(col = id, into = c("Strain", "Bio_rep"), sep = "_", remove = TRUE)

nta_total_tukey <- aov(part_per_prot ~ Strain, data = nta_total) %>% 
  tukey_hsd()

nta_total_dunns <- dunns_test(x = nta_total$Particle_count, 
                              g = nta_total$Strain, 
                              method = "bh")

```


```{r figure2plots}
f2a_img <- png::readPNG("./vignettes/figures/figure2-v2.png")

f2a <- ggplot() + 
  background_image(f2a_img) + 
  theme(plot.margin = margin(t = 0.3, l = 0, r = 0, b = 0, unit = "inches"))

f2b <- nta_bioavg %>% 
  ggplot(aes(x = particle_size, y = Bio_rep_mean, colour = Strain)) + 
  scale_colour_manual(values = c("green", "red", "blue", "purple"), 
                      breaks = c("Biofilm", "DAY286", "ATCC90028", "ATCC10231"), 
                      labels = c("DAY286 B", "DAY286 Y", "ATCC90028", "ATCC10231")) + 
  geom_line(size = 1) + 
  facet_wrap(~ facet, scales = "free", ncol = 2, nrow = 1) + 
  theme_classic() + 
  theme(strip.background = element_blank(), 
        strip.text = element_blank(), 
        legend.position = c(0.88, 0.6), 
        legend.title = element_blank(), 
        plot.margin = margin(t = 0.2, l = 0, r = 0, b = 0, unit = "inches")) + 
  xlab(label = "Particle size (nm)") + 
  ylab(label = "Particles / mL")

f2c1 <- nta_total %>% 
  ggboxplot(x = "Strain", y = "Particle_count", 
            color = "Strain", palette = "jco", add = "jitter")
f2c1 <- ggpar(f2c1, 
              yscale = "log10", 
              format.scale = TRUE,
              ylim = c(1e11, 1e13)) + 
  stat_pvalue_manual(nta_total_dunns[c(1,2), ], 
                     label = "p.adj", 
                     y.position = c(12.4, 13), 
                     tip.length = 4e-3)

f2c2 <- nta_total %>% 
  ggboxplot(x = "Strain", y = "part_per_prot", 
            color = "Strain", palette = c("green", "red", "blue", "purple"), add = "jitter", 
            ylab = expression("Particles /"~paste(mu,g)~"protein"))
f2c2 <- ggpar(f2c2, 
              yscale = "log10", 
              format.scale = TRUE, 
              ylim = c(8e8, 8e10), 
              legend = "none") + 
  stat_pvalue_manual(nta_total_tukey[c(2,4,6), ], label = "p.adj", 
                     y.position = c(10.7, 10.5, 10.85), 
                     tip.length = 1e-2, 
                     label.size = 3) + 
  theme(axis.text.x = element_blank(), 
        axis.title.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        plot.margin = margin(t = 0.2, l = 0.2, r = 0, b = 0, unit = "inches"))

```


```{r figure2, fig.cap='EV characterisation', fig.width=7.1, fig.height=4}

ggarrange(f2a, 
          ggarrange(f2b, f2c2, 
                    labels = c("B", "C"), 
                    ncol = 2,
                    nrow = 1, 
                    widths = c(1.8,1)), 
          labels = c("A", ""), 
          nrow = 2, 
          ncol = 1, 
          heights = c(1,1))

```

\newpage

```{r figure3Data}
f3a1 <- plot_venn(list("EV" = y_ev, "WCL" = y_wcl), 
                  use_uniprot = TRUE, type = "plot", 
                  fontfamily = "sans", 
                  cat.fontfamily = "sans", 
                  cat.just = list(c(0.5, 0.8), c(0,2)))

f3a1 <- as_ggplot(f3a1)

f3a2 <- plot_volcano(data = yeast_res, 
                     p_val = adj.P.Val, 
                     lfc = logFC,
                     grp = group, 
                     label = ifelse(logFC >= 8, CGD_gene_name, "")) + 
  scale_colour_manual(labels = c("EV enriched", "Cell enriched", "ns"), 
                      values = c("orange", "grey", "purple"), 
                      breaks = c("EV up", "WCL up", "not sig"))

f3b1 <- plot_venn(list("EV" = b_ev, "WCL" = b_wcl), 
                  use_uniprot = TRUE, type = "plot", 
                  fontfamily = "sans", 
                  cat.fontfamily = "sans", 
                  cat.just = list(c(0.5,0.8), c(0,2)))

f3b1 <- as_ggplot(f3b1)

f3b2 <- plot_volcano(data = biofilm_res, 
                     p_val = adj.P.Val, 
                     lfc = logFC,
                     grp = group, 
                     label = ifelse(logFC >= 8, CGD_gene_name, "")) + 
  scale_colour_manual(labels = c("EV enriched", "Cell enriched", "ns"), 
                      values = c("red", "gray", "blue"), 
                      breaks = c("EV up", "WCL up", "not sig"))

f3c1 <- plot_venn(list("EV" = atcc9_ev, "WCL" = atcc9_w), 
                  use_uniprot = TRUE, type = "plot", 
                  fontfamily = "sans", 
                  cat.fontfamily = "sans", 
                  cat.just = list(c(0.5,0.8), c(0,2)))

f3c1 <- as_ggplot(f3c1)

f3c2 <- plot_volcano(data = a9_res, 
                     p_val = adj.P.Val, 
                     lfc = logFC,
                     grp = group, 
                     label = ifelse(logFC >= 8, CGD_gene_name, "")) + 
  scale_colour_manual(labels = c("EV enriched", "Cell enriched", "ns"), 
                      values = c("red", "green", "gray"))

f3d1 <- plot_venn(list("EV" = atcc1_ev, "WCL" = atcc1_w), 
                 use_uniprot = TRUE, type = "plot", 
                  fontfamily = "sans", 
                  cat.fontfamily = "sans", 
                  cat.just = list(c(0.5,0.8), c(0,2)))

f3d1 <- as_ggplot(f3d1)

f3d2 <- plot_volcano(data = a1_res, 
                     p_val = adj.P.Val, 
                     lfc = logFC,
                     grp = group, 
                     label = ifelse(logFC >= 8, CGD_gene_name, "")) + 
  scale_colour_manual(labels = c("EV enriched", "Cell enriched", "ns"), 
                      values = c("pink", "cyan", "gray"))


```


```{r figure3, fig.cap='Volcano plots', fig.width=6, fig.height=7}
# ggarrange(f3a1, f3a2,
#           f3b1, f3b2,
#           f3c1, f3c2,
#           f3d1, f3d2,
#           labels = c("A", "DAY286 yeast", "B", "DAY286 biofilm", "C", "ATCC90028", "D", "ATCC10231"), 
#           hjust = c(-0.5, 0.4, -0.5, 0.4, -0.5, 0.4, -0.5, 0.4), 
#           ncol = 2, 
#           nrow = 4, 
#           widths = c(1,1.5))
```

\newpage

```{r figure4, fig.cap='GO terms', fig.width=7.2, fig.height=4}
fig4 <- multi_panel_figure(width = 7.1, height = 4, unit = "inches", columns = 2, rows = 2, 
                           row_spacing = 0, column_spacing = 0)
fig4

```

\newpage

```{r figure5, fig.cap='heatmap etc.'}
plot(mtcars[,1:2])
```

\newpage

```{r figure6, fig.cap='4tm domain'}
plot(mtcars[,1:2])
```

\newpage

```{r figure7, fig.cap='final candidates'}
plot(mtcars[,1:2])
```



